<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Partner Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    #setup-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      margin: 50px auto;
    }

    .auth-title {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }

    .auth-subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn-primary {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-message,
    .success-message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message {
      background: #fee;
      color: #c00;
      border: 1px solid #fcc;
    }

    .success-message {
      background: #efe;
      color: #060;
      border: 1px solid #cfc;
    }

    #dashboard-screen {
      display: none;
    }

    .dashboard-header {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .header-actions {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-bottom: 20px;
    }

    .language-selector {
      padding: 8px 15px;
      border: 2px solid #667eea;
      border-radius: 8px;
      background: white;
      color: #667eea;
      font-weight: 500;
      cursor: pointer;
    }

    .logout-btn {
      padding: 8px 20px;
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #ff3838;
    }

    .dashboard-header h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 10px;
    }

    .partner-info {
      color: #666;
      font-size: 16px;
    }

    .referral-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .referral-card h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .referral-info {
      display: grid;
      gap: 20px;
    }

    .referral-item {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .referral-item label {
      display: block;
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .referral-item .value {
      color: #333;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      word-break: break-all;
    }

    .copy-btn {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .copy-btn:hover {
      background: #5568d3;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }

    .stat-card .icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .stat-card .label {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }

    .users-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .users-section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      padding: 15px;
      text-align: left;
      color: #333;
      font-weight: 600;
      border-bottom: 2px solid #e0e0e0;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      color: #666;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .no-users {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- PROFILE SETUP SCREEN -->
    <div id="setup-screen">
      <h1 id="setup-title">üöÄ Partner Setup</h1>
      <p id="setup-subtitle">Welcome! Let's set up your partner dashboard.</p>

      <div class="error-message" id="setup-error"></div>
      <div class="success-message" id="setup-success"></div>

      <div class="input-group">
        <label for="language" id="label-language">Language / ‡§≠‡§æ‡§∑‡§æ / ‡™≠‡™æ‡™∑‡™æ *</label>
        <select id="language" onchange="changeLanguage(this.value)">
          <option value="en">English</option>
          <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
          <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
        </select>
      </div>

      <div class="input-group">
        <label for="platform" id="label-platform">Platform *</label>
        <select id="platform" required>
          <option value="" id="option-select-platform">Select Platform</option>
          <option value="instagram">Instagram</option>
          <option value="whatsapp">WhatsApp</option>
        </select>
      </div>

      <div class="input-group">
        <label for="channel-name" id="label-channel-name">Channel Name *</label>
        <input type="text" id="channel-name" required>
      </div>

      <div class="input-group">
        <label for="referral-code" id="label-referral-code">Referral Code (Admin Provided) *</label>
        <input type="text" id="referral-code" required>
      </div>

      <button class="btn-primary" id="setup-btn" onclick="setupPartner()">Complete Setup</button>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen">
      <div class="dashboard-header">
        <div class="header-actions">
          <select class="language-selector" id="dashboard-language" onchange="changeLanguage(this.value)">
            <option value="en">English</option>
            <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
            <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
          </select>
          <button class="logout-btn" onclick="logout()"><span id="btn-logout">üö™ Logout</span></button>
        </div>
        <h1 id="dashboard-title">üìä Partner Dashboard</h1>
        <p class="partner-info" id="partner-info"></p>
      </div>

      <div class="referral-card">
        <h2 id="referral-details-title">üîó Your Referral Details</h2>
        <div class="referral-info">
          <div class="referral-item">
            <label id="label-ref-code">Referral Code</label>
            <div class="value" id="display-code">-</div>
            <button class="copy-btn" onclick="copyCode()"><span id="btn-copy-code">üìã Copy Code</span></button>
          </div>
          <div class="referral-item">
            <label id="label-ref-link">Referral Link</label>
            <div class="value" id="display-link" style="font-size: 14px;">-</div>
            <button class="copy-btn" onclick="copyLink()"><span id="btn-copy-link">üìã Copy Link</span></button>
          </div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="icon">üë•</div>
          <div class="label" id="stat-label-total">Total Users Referred</div>
          <div class="value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
          <div class="icon">üéØ</div>
          <div class="label" id="stat-label-today">Users Joined Today</div>
          <div class="value" id="stat-today">0</div>
        </div>
        <div class="stat-card">
          <div class="icon">üìÖ</div>
          <div class="label" id="stat-label-month">Users Joined This Month</div>
          <div class="value" id="stat-month">0</div>
        </div>
        <div class="stat-card">
          <div class="icon">üî•</div>
          <div class="label" id="stat-label-active">Total Active Days/Month</div>
          <div class="value" id="stat-active">0</div>
        </div>
      </div>

      <div class="users-section">
        <h2 id="users-section-title">üìã Your Referred Users</h2>
        <div id="users-content">
          <div class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: #666;" id="loading-text">Loading users...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs (Only Firestore for data) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // ===== FIREBASE CONFIGURATION - DATA PROJECT ONLY =====
    const dataFirebaseConfig = {
      apiKey: "AIzaSyDWnZYA70GL_q-JKN9yle1jiJJ39xd7e7I",
      authDomain: "textbookhubtracker.firebaseapp.com",
      projectId: "textbookhubtracker",
      storageBucket: "textbookhubtracker.appspot.com",
      messagingSenderId: "402739864619",
      appId: "1:402739864619:web:5827eb3473b2d286aeb66e"
    };

    // Initialize Firebase App
    firebase.initializeApp(dataFirebaseConfig);
    const dataDb = firebase.firestore();

    // ===== TRANSLATIONS =====
    const translations = {
      en: {
        setupTitle: "üöÄ Partner Setup",
        setupSubtitle: "Welcome! Let's set up your partner dashboard.",
        labelPlatform: "Platform *",
        optionSelectPlatform: "Select Platform",
        labelChannelName: "Channel Name *",
        placeholderChannelName: "Enter your channel name",
        labelReferralCode: "Referral Code (Admin Provided) *",
        placeholderReferralCode: "Enter your referral code",
        btnEnterDashboard: "Complete Setup",
        btnSettingUp: "Setting up...",
        errorSelectPlatform: "‚ùå Please select a platform",
        errorEnterChannel: "‚ùå Please enter your channel name",
        errorEnterCode: "‚ùå Please enter your referral code",
        errorInvalidCode: "‚ùå Invalid referral code. Please check with admin.",
        errorPlatformMismatch: "‚ùå This code is for {platform}, but you selected {selected}",
        errorCodeInUse: "‚ùå This referral code is already in use by another partner",
        errorSetupFailed: "‚ùå Setup failed: ",
        successSetup: "‚úÖ Profile created successfully! Loading dashboard...",
        dashboardTitle: "üìä Partner Dashboard",
        btnLogout: "üö™ Logout",
        referralDetailsTitle: "üîó Your Referral Details",
        labelRefCode: "Referral Code",
        labelRefLink: "Referral Link",
        btnCopyCode: "üìã Copy Code",
        btnCopyLink: "üìã Copy Link",
        statLabelTotal: "Total Users Referred",
        statLabelToday: "Users Joined Today",
        statLabelMonth: "Users Joined This Month",
        statLabelActive: "Total Active Days/Month",
        usersSectionTitle: "üìã Your Referred Users",
        loadingText: "Loading users...",
        noUsers: "No users found yet. Share your referral link to get started!",
        tableHeaderName: "Name",
        tableHeaderAge: "Age",
        tableHeaderJoined: "Joined Date",
        tableHeaderEntry: "Entry Point",
        tableHeaderActive: "Active Days",
        days: "days",
        alertCodeCopied: "‚úÖ Referral code copied to clipboard!",
        alertLinkCopied: "‚úÖ Referral link copied to clipboard!",
        alertCopyFailed: "‚ùå Failed to copy: ",
        confirmLogout: "Are you sure you want to logout?",
        errorLoadingData: "‚ö†Ô∏è Error loading data. Please refresh the page."
      },
      hi: {
        setupTitle: "üöÄ ‡§™‡§æ‡§∞‡•ç‡§ü‡§®‡§∞ ‡§∏‡•á‡§ü‡§Ö‡§™",
        setupSubtitle: "‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! ‡§Ü‡§á‡§è ‡§Ö‡§™‡§®‡§æ ‡§™‡§æ‡§∞‡•ç‡§ü‡§®‡§∞ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§",
        labelPlatform: "‡§™‡•ç‡§≤‡•á‡§ü‡§´‡§º‡•â‡§∞‡•ç‡§Æ *",
        optionSelectPlatform: "‡§™‡•ç‡§≤‡•á‡§ü‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç",
        labelChannelName: "‡§ö‡•à‡§®‡§≤ ‡§ï‡§æ ‡§®‡§æ‡§Æ *",
        placeholderChannelName: "‡§Ö‡§™‡§®‡§æ ‡§ö‡•à‡§®‡§≤ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
        labelReferralCode: "‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§ï‡•ã‡§° (‡§è‡§°‡§Æ‡§ø‡§® ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ) *",
        placeholderReferralCode: "‡§Ö‡§™‡§®‡§æ ‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
        btnEnterDashboard: "‡§∏‡•á‡§ü‡§Ö‡§™ ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç",
        btnSettingUp: "‡§∏‡•á‡§ü‡§Ö‡§™ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...",
        errorSelectPlatform: "‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§™‡•ç‡§≤‡•á‡§ü‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç",
        errorEnterChannel: "‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§ö‡•à‡§®‡§≤ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
        errorEnterCode: "‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
        errorInvalidCode: "‚ùå ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§ï‡•ã‡§°‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§°‡§Æ‡§ø‡§® ‡§∏‡•á ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§",
        errorPlatformMismatch: "‚ùå ‡§Ø‡§π ‡§ï‡•ã‡§° {platform} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ü‡§™‡§®‡•á {selected} ‡§ö‡•Å‡§®‡§æ",
        errorCodeInUse: "‚ùå ‡§Ø‡§π ‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§ï‡•ã‡§° ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§ï‡§ø‡§∏‡•Ä ‡§Ö‡§®‡•ç‡§Ø ‡§™‡§æ‡§∞‡•ç‡§ü‡§®‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§Æ‡•á‡§Ç ‡§π‡•à",
        errorSetupFailed: "‚ùå ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§µ‡§ø‡§´‡§≤: ",
        successSetup: "‚úÖ ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§®‡§æ‡§à ‡§ó‡§à! ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...",
        dashboardTitle: "üìä ‡§™‡§æ‡§∞‡•ç‡§ü‡§®‡§∞ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°",
        btnLogout: "üö™ ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü",
        referralDetailsTitle: "üîó ‡§Ü‡§™‡§ï‡•á ‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§µ‡§ø‡§µ‡§∞‡§£",
        labelRefCode: "‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§ï‡•ã‡§°",
        labelRefLink: "‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§≤‡§ø‡§Ç‡§ï",
        btnCopyCode: "üìã ‡§ï‡•ã‡§° ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç",
        btnCopyLink: "üìã ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç",
        statLabelTotal: "‡§ï‡•Å‡§≤ ‡§∞‡•á‡§´‡§º‡§∞ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ",
        statLabelToday: "‡§Ü‡§ú ‡§ú‡•Å‡§°‡§º‡•á ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ",
        statLabelMonth: "‡§á‡§∏ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ",
        statLabelActive: "‡§ï‡•Å‡§≤ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§¶‡§ø‡§®/‡§Æ‡§π‡•Ä‡§®‡§æ",
        usersSectionTitle: "üìã ‡§Ü‡§™‡§ï‡•á ‡§∞‡•á‡§´‡§º‡§∞ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ",
        loadingText: "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...",
        noUsers: "‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡§æ ‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§≤‡§ø‡§Ç‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç!",
        tableHeaderName: "‡§®‡§æ‡§Æ",
        tableHeaderAge: "‡§â‡§Æ‡•ç‡§∞",
        tableHeaderJoined: "‡§ú‡•Å‡§°‡§º‡§®‡•á ‡§ï‡•Ä ‡§§‡§ø‡§•‡§ø",
        tableHeaderEntry: "‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§™‡•â‡§á‡§Ç‡§ü",
        tableHeaderActive: "‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§¶‡§ø‡§®",
        days: "‡§¶‡§ø‡§®",
        alertCodeCopied: "‚úÖ ‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§ï‡•ã‡§° ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!",
        alertLinkCopied: "‚úÖ ‡§∞‡•á‡§´‡§º‡§∞‡§≤ ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!",
        alertCopyFailed: "‚ùå ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ",
        confirmLogout: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?",
        errorLoadingData: "‚ö†Ô∏è ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•á‡§ú ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§"
      },
      gu: {
        setupTitle: "üöÄ ‡™™‡™æ‡™∞‡´ç‡™ü‡™®‡™∞ ‡™∏‡´á‡™ü‡™Ö‡™™",
        setupSubtitle: "‡™∏‡´ç‡™µ‡™æ‡™ó‡™§ ‡™õ‡´á! ‡™ö‡™æ‡™≤‡´ã ‡™§‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™™‡™æ‡™∞‡´ç‡™ü‡™®‡™∞ ‡™°‡´á‡™∂‡™¨‡´ã‡™∞‡´ç‡™° ‡™∏‡´á‡™ü‡™Ö‡™™ ‡™ï‡™∞‡´Ä‡™è.",
        labelPlatform: "‡™™‡´ç‡™≤‡´á‡™ü‡™´‡´ã‡™∞‡´ç‡™Æ *",
        optionSelectPlatform: "‡™™‡´ç‡™≤‡´á‡™ü‡™´‡´ã‡™∞‡´ç‡™Æ ‡™™‡™∏‡™Ç‡™¶ ‡™ï‡™∞‡´ã",
        labelChannelName: "‡™ö‡´á‡™®‡™≤‡™®‡´Å‡™Ç ‡™®‡™æ‡™Æ *",
        placeholderChannelName: "‡™§‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™ö‡´á‡™®‡™≤ ‡™®‡™æ‡™Æ ‡™¶‡™æ‡™ñ‡™≤ ‡™ï‡™∞‡´ã",
        labelReferralCode: "‡™∞‡´á‡™´‡™∞‡™≤ ‡™ï‡´ã‡™° (‡™è‡™°‡™Æ‡™ø‡™® ‡™¶‡´ç‡™µ‡™æ‡™∞‡™æ ‡™™‡´Ç‡™∞‡´ã ‡™™‡™æ‡™°‡™µ‡™æ‡™Æ‡™æ‡™Ç ‡™Ü‡™µ‡´á‡™≤) *",
        placeholderReferralCode: "‡™§‡™Æ‡™æ‡™∞‡´ã ‡™∞‡´á‡™´‡™∞‡™≤ ‡™ï‡´ã‡™° ‡™¶‡™æ‡™ñ‡™≤ ‡™ï‡™∞‡´ã",
        btnEnterDashboard: "‡™∏‡´á‡™ü‡™Ö‡™™ ‡™™‡´Ç‡™∞‡´ç‡™£ ‡™ï‡™∞‡´ã",
        btnSettingUp: "‡™∏‡´á‡™ü‡™Ö‡™™ ‡™•‡™à ‡™∞‡™π‡´ç‡™Ø‡´Å‡™Ç ‡™õ‡´á...",
        errorSelectPlatform: "‚ùå ‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™è‡™ï ‡™™‡´ç‡™≤‡´á‡™ü‡™´‡´ã‡™∞‡´ç‡™Æ ‡™™‡™∏‡™Ç‡™¶ ‡™ï‡™∞‡´ã",
        errorEnterChannel: "‚ùå ‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™§‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™ö‡´á‡™®‡™≤ ‡™®‡™æ‡™Æ ‡™¶‡™æ‡™ñ‡™≤ ‡™ï‡™∞‡´ã",
        errorEnterCode: "‚ùå ‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™§‡™Æ‡™æ‡™∞‡´ã ‡™∞‡´á‡™´‡™∞‡™≤ ‡™ï‡´ã‡™° ‡™¶‡™æ‡™ñ‡™≤ ‡™ï‡™∞‡´ã",
        errorInvalidCode: "‚ùå ‡™Ö‡™Æ‡™æ‡™®‡´ç‡™Ø ‡™∞‡´á‡™´‡™∞‡™≤ ‡™ï‡´ã‡™°. ‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™è‡™°‡™Æ‡™ø‡™® ‡™∏‡™æ‡™•‡´á ‡™§‡™™‡™æ‡™∏‡´ã.",
        errorPlatformMismatch: "‚ùå ‡™Ü ‡™ï‡´ã‡™° {platform} ‡™Æ‡™æ‡™ü‡´á ‡™õ‡´á, ‡™™‡™∞‡™Ç‡™§‡´Å ‡™§‡™Æ‡´á {selected} ‡™™‡™∏‡™Ç‡™¶ ‡™ï‡™∞‡´ç‡™Ø‡´Å‡™Ç",
        errorCodeInUse: "‚ùå ‡™Ü ‡™∞‡´á‡™´‡™∞‡™≤ ‡™ï‡´ã‡™° ‡™™‡™π‡´á‡™≤‡´á‡™•‡´Ä ‡™ú ‡™Ö‡™®‡´ç‡™Ø ‡™™‡™æ‡™∞‡´ç‡™ü‡™®‡™∞ ‡™¶‡´ç‡™µ‡™æ‡™∞‡™æ ‡™â‡™™‡™Ø‡´ã‡™ó‡™Æ‡™æ‡™Ç ‡™õ‡´á",
        errorSetupFailed: "‚ùå ‡™∏‡´á‡™ü‡™Ö‡™™ ‡™®‡™ø‡™∑‡´ç‡™´‡™≥: ",
        successSetup: "‚úÖ ‡™™‡´ç‡™∞‡´ã‡™´‡™æ‡™á‡™≤ ‡™∏‡™´‡™≥‡™§‡™æ‡™™‡´Ç‡™∞‡´ç‡™µ‡™ï ‡™¨‡™®‡™æ‡™µ‡´Ä! ‡™°‡´á‡™∂‡™¨‡´ã‡™∞‡´ç‡™° ‡™≤‡´ã‡™° ‡™•‡™à ‡™∞‡™π‡´ç‡™Ø‡´Å‡™Ç ‡™õ‡´á...",
        dashboardTitle: "üìä ‡™™‡™æ‡™∞‡´ç‡™ü‡™®‡™∞ ‡™°‡´á‡™∂‡™¨‡´ã‡™∞‡´ç‡™°",
        btnLogout: "üö™ ‡™≤‡´â‡™ó‡™Ü‡™â‡™ü",
        referralDetailsTitle: "üîó ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™∞‡´á‡™´‡™∞‡™≤ ‡™µ‡™ø‡™ó‡™§‡´ã",
        labelRefCode: "‡™∞‡´á‡™´‡™∞‡™≤ ‡™ï‡´ã‡™°",
        labelRefLink: "‡™∞‡´á‡™´‡™∞‡™≤ ‡™≤‡™ø‡™Ç‡™ï",
        btnCopyCode: "üìã ‡™ï‡´ã‡™° ‡™ï‡´â‡™™‡™ø ‡™ï‡™∞‡´ã",
        btnCopyLink: "üìã ‡™≤‡™ø‡™Ç‡™ï ‡™ï‡´â‡™™‡™ø ‡™ï‡™∞‡´ã",
        statLabelTotal: "‡™ï‡´Å‡™≤ ‡™∞‡´á‡™´‡™∞ ‡™ï‡™∞‡´á‡™≤ ‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ‡™ì",
        statLabelToday: "‡™Ü‡™ú‡´á ‡™ú‡´ã‡™°‡™æ‡™Ø‡´á‡™≤‡™æ ‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ‡™ì",
        statLabelMonth: "‡™Ü ‡™Æ‡™π‡™ø‡™®‡´á ‡™ú‡´ã‡™°‡™æ‡™Ø‡´á‡™≤‡™æ ‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ‡™ì",
        statLabelActive: "‡™ï‡´Å‡™≤ ‡™∏‡™ï‡´ç‡™∞‡™ø‡™Ø ‡™¶‡™ø‡™µ‡™∏‡´ã/‡™Æ‡™π‡™ø‡™®‡´ã",
        usersSectionTitle: "üìã ‡™§‡™Æ‡™æ‡™∞‡™æ ‡™∞‡´á‡™´‡™∞ ‡™ï‡™∞‡´á‡™≤ ‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ‡™ì",
        loadingText: "‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ‡™ì ‡™≤‡´ã‡™° ‡™•‡™à ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´á...",
        noUsers: "‡™π‡™ú‡´Å ‡™∏‡´Å‡™ß‡´Ä ‡™ï‡´ã‡™à ‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ‡™ì ‡™Æ‡™≥‡´ç‡™Ø‡™æ ‡™®‡™•‡´Ä. ‡™∂‡™∞‡´Ç ‡™ï‡™∞‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™∞‡´á‡™´‡™∞‡™≤ ‡™≤‡™ø‡™Ç‡™ï ‡™∂‡´á‡™∞ ‡™ï‡™∞‡´ã!",
        tableHeaderName: "‡™®‡™æ‡™Æ",
        tableHeaderAge: "‡™â‡™Ç‡™Æ‡™∞",
        tableHeaderJoined: "‡™ú‡´ã‡™°‡™æ‡™Ø‡™æ ‡™§‡™æ‡™∞‡´Ä‡™ñ",
        tableHeaderEntry: "‡™è‡™®‡´ç‡™ü‡´ç‡™∞‡´Ä ‡™™‡´ã‡™á‡™®‡´ç‡™ü",
        tableHeaderActive: "‡™∏‡™ï‡´ç‡™∞‡™ø‡™Ø ‡™¶‡™ø‡™µ‡™∏‡´ã",
        days: "‡™¶‡™ø‡™µ‡™∏‡´ã",
        alertCodeCopied: "‚úÖ ‡™∞‡´á‡™´‡™∞‡™≤ ‡™ï‡´ã‡™° ‡™ï‡´ç‡™≤‡™ø‡™™‡™¨‡´ã‡™∞‡´ç‡™° ‡™™‡™∞ ‡™ï‡´â‡™™‡™ø ‡™•‡™Ø‡´ã!",
        alertLinkCopied: "‚úÖ ‡™∞‡´á‡™´‡™∞‡™≤ ‡™≤‡™ø‡™Ç‡™ï ‡™ï‡´ç‡™≤‡™ø‡™™‡™¨‡´ã‡™∞‡´ç‡™° ‡™™‡™∞ ‡™ï‡´â‡™™‡™ø ‡™•‡™à!",
        alertCopyFailed: "‚ùå ‡™ï‡´â‡™™‡™ø ‡™ï‡™∞‡™µ‡™æ‡™Æ‡™æ‡™Ç ‡™®‡™ø‡™∑‡´ç‡™´‡™≥: ",
        confirmLogout: "‡™∂‡´Å‡™Ç ‡™§‡™Æ‡´á ‡™ñ‡™∞‡´á‡™ñ‡™∞ ‡™≤‡´â‡™ó‡™Ü‡™â‡™ü ‡™ï‡™∞‡™µ‡™æ ‡™Æ‡™æ‡™Ç‡™ó‡´ã ‡™õ‡´ã?",
        errorLoadingData: "‚ö†Ô∏è ‡™°‡´á‡™ü‡™æ ‡™≤‡´ã‡™° ‡™ï‡™∞‡™µ‡™æ‡™Æ‡™æ‡™Ç ‡™≠‡´Ç‡™≤. ‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™™‡´á‡™ú ‡™∞‡™ø‡™´‡´ç‡™∞‡´á‡™∂ ‡™ï‡™∞‡´ã."
      }
    };

    let currentLanguage = localStorage.getItem('partnerLanguage') || 'en';
    let currentPartnerData = null;

    const referralData = {
      instagram: [
        { code: "IG-10001", username: "Instagram Partner 1" },
        { code: "IG-10002", username: "Instagram Partner 2" },
        { code: "IG-10003", username: "Instagram Partner 3" },
        { code: "IG-10004", username: "Instagram Partner 4" },
        { code: "IG-10005", username: "Instagram Partner 5" },
        { code: "IG-10006", username: "Instagram Partner 6" },
        { code: "IG-10007", username: "Instagram Partner 7" },
        { code: "IG-10008", username: "Instagram Partner 8" },
        { code: "IG-10009", username: "Instagram Partner 9" },
        { code: "IG-10010", username: "Instagram Partner 10" },
        { code: "IG-10011", username: "Instagram Partner 11" },
        { code: "IG-10012", username: "Instagram Partner 12" },
        { code: "IG-10013", username: "Instagram Partner 13" },
        { code: "IG-10014", username: "Instagram Partner 14" },
        { code: "IG-10015", username: "Instagram Partner 15" },
        { code: "IG-10016", username: "Instagram Partner 16" },
        { code: "IG-10017", username: "Instagram Partner 17" },
        { code: "IG-10018", username: "Instagram Partner 18" },
        { code: "IG-10019", username: "Instagram Partner 19" },
        { code: "IG-10020", username: "Instagram Partner 20" },
        { code: "IG-10021", username: "Instagram Partner 21" },
        { code: "IG-10022", username: "Instagram Partner 22" },
        { code: "IG-10023", username: "Instagram Partner 23" },
        { code: "IG-10024", username: "Instagram Partner 24" },
        { code: "IG-10025", username: "Instagram Partner 25" },
        { code: "IG-10026", username: "Instagram Partner 26" },
        { code: "IG-10027", username: "Instagram Partner 27" },
        { code: "IG-10028", username: "Instagram Partner 28" },
        { code: "IG-10029", username: "Instagram Partner 29" },
        { code: "IG-10030", username: "Instagram Partner 30" },
        { code: "IG-10031", username: "Instagram Partner 31" },
        { code: "IG-10032", username: "Instagram Partner 32" },
        { code: "IG-10033", username: "Instagram Partner 33" },
        { code: "IG-10034", username: "Instagram Partner 34" },
        { code: "IG-10035", username: "Instagram Partner 35" },
        { code: "IG-10036", username: "Instagram Partner 36" },
        { code: "IG-10037", username: "Instagram Partner 37" },
        { code: "IG-10038", username: "Instagram Partner 38" },
        { code: "IG-10039", username: "Instagram Partner 39" },
        { code: "IG-10040", username: "Instagram Partner 40" },
        { code: "IG-10041", username: "Instagram Partner 41" },
        { code: "IG-10042", username: "Instagram Partner 42" },
        { code: "IG-10043", username: "Instagram Partner 43" },
        { code: "IG-10044", username: "Instagram Partner 44" },
        { code: "IG-10045", username: "Instagram Partner 45" },
        { code: "IG-10046", username: "Instagram Partner 46" },
        { code: "IG-10047", username: "Instagram Partner 47" },
        { code: "IG-10048", username: "Instagram Partner 48" },
        { code: "IG-10049", username: "Instagram Partner 49" },
        { code: "IG-10050", username: "Instagram Partner 50" },
        { code: "IG-10051", username: "Instagram Partner 51" },
        { code: "IG-10052", username: "Instagram Partner 52" },
        { code: "IG-10053", username: "Instagram Partner 53" },
        { code: "IG-10054", username: "Instagram Partner 54" },
        { code: "IG-10055", username: "Instagram Partner 55" },
        { code: "IG-10056", username: "Instagram Partner 56" }
      ],

      whatsapp: [
        { code: "WA-20001", name: "WhatsApp Partner 1" },
        { code: "WA-20002", name: "WhatsApp Partner 2" },
        { code: "WA-20003", name: "WhatsApp Partner 3" },
        { code: "WA-20004", name: "WhatsApp Partner 4" },
        { code: "WA-20005", name: "WhatsApp Partner 5" },
        { code: "WA-20006", name: "WhatsApp Partner 6" },
        { code: "WA-20007", name: "WhatsApp Partner 7" },
        { code: "WA-20008", name: "WhatsApp Partner 8" },
        { code: "WA-20009", name: "WhatsApp Partner 9" },
        { code: "WA-20010", name: "WhatsApp Partner 10" },
        { code: "WA-20011", name: "WhatsApp Partner 11" },
        { code: "WA-20012", name: "WhatsApp Partner 12" },
        { code: "WA-20013", name: "WhatsApp Partner 13" },
        { code: "WA-20014", name: "WhatsApp Partner 14" },
        { code: "WA-20015", name: "WhatsApp Partner 15" },
        // Newly added partners
        { code: "WA-20016", name: "WhatsApp Partner 16" },
        { code: "WA-20017", name: "WhatsApp Partner 17" },
        { code: "WA-20018", name: "WhatsApp Partner 18" },
        { code: "WA-20019", name: "WhatsApp Partner 19" },
        { code: "WA-20020", name: "WhatsApp Partner 20" },
        { code: "WA-20021", name: "WhatsApp Partner 21" },
        { code: "WA-20022", name: "WhatsApp Partner 22" },
        { code: "WA-20023", name: "WhatsApp Partner 23" },
        { code: "WA-20024", name: "WhatsApp Partner 24" },
        { code: "WA-20025", name: "WhatsApp Partner 25" },
        { code: "WA-20026", name: "WhatsApp Partner 26" },
        { code: "WA-20027", name: "WhatsApp Partner 27" },
        { code: "WA-20028", name: "WhatsApp Partner 28" },
        { code: "WA-20029", name: "WhatsApp Partner 29" },
        { code: "WA-20030", name: "WhatsApp Partner 30" }
      ]
    };

    // ===== VALIDATE REFERRAL CODE (EXISTING - UNTOUCHED) =====
    function validateReferralCode(code) {
      if (!code) return null;
      const upperCode = code.trim().toUpperCase();

      for (const ref of referralData.instagram) {
        if (ref.code === upperCode) {
          return {
            referralCode: upperCode,
            platform: "instagram",
            sourceName: ref.username
          };
        }
      }

      for (const ref of referralData.whatsapp) {
        if (ref.code === upperCode) {
          return {
            referralCode: upperCode,
            platform: "whatsapp",
            sourceName: ref.name
          };
        }
      }

      return null;
    }

    // ===== CHECK IF PARTNER EXISTS ON LOAD =====
    window.addEventListener('DOMContentLoaded', () => {
      const savedPartner = localStorage.getItem('partnerData');
      if (savedPartner) {
        try {
          currentPartnerData = JSON.parse(savedPartner);
          showDashboard(currentPartnerData);
        } catch (e) {
          console.error('Error loading saved partner data:', e);
          showSetupScreen();
        }
      } else {
        showSetupScreen();
      }
    });

    // ===== SETUP PARTNER =====
    async function setupPartner() {
      const t = translations[currentLanguage];
      const platform = document.getElementById('platform').value;
      const channelName = document.getElementById('channel-name').value.trim();
      const referralCode = document.getElementById('referral-code').value.trim().toUpperCase();

      const errorDiv = document.getElementById('setup-error');
      const successDiv = document.getElementById('setup-success');
      const setupBtn = document.getElementById('setup-btn');

      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      // Validation
      if (!platform) {
        errorDiv.textContent = t.errorSelectPlatform;
        errorDiv.style.display = 'block';
        return;
      }

      if (!channelName) {
        errorDiv.textContent = t.errorEnterChannel;
        errorDiv.style.display = 'block';
        return;
      }

      if (!referralCode) {
        errorDiv.textContent = t.errorEnterCode;
        errorDiv.style.display = 'block';
        return;
      }

      const validation = validateReferralCode(referralCode);
      if (!validation) {
        errorDiv.textContent = t.errorInvalidCode;
        errorDiv.style.display = 'block';
        return;
      }

      if (validation.platform !== platform) {
        errorDiv.textContent = t.errorPlatformMismatch
          .replace('{platform}', validation.platform)
          .replace('{selected}', platform);
        errorDiv.style.display = 'block';
        return;
      }

      setupBtn.disabled = true;
      setupBtn.textContent = t.btnSettingUp;

      try {
        // Save partner profile to localStorage
        const partnerDoc = {
          platform,
          channelName,
          referralCode,
          sourceName: validation.sourceName,
          language: currentLanguage,
          profileComplete: true,
          setupDate: new Date().toISOString()
        };

        localStorage.setItem('partnerData', JSON.stringify(partnerDoc));
        currentPartnerData = partnerDoc;

        successDiv.textContent = t.successSetup;
        successDiv.style.display = 'block';

        setTimeout(() => {
          showDashboard(partnerDoc);
        }, 1000);

      } catch (error) {
        console.error('Setup error:', error);
        errorDiv.textContent = t.errorSetupFailed + error.message;
        errorDiv.style.display = 'block';
        setupBtn.disabled = false;
        setupBtn.textContent = t.btnEnterDashboard;
      }
    }

    // ===== SHOW DASHBOARD =====
    async function showDashboard(partnerData) {
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('dashboard-screen').style.display = 'block';

      if (partnerData.language) {
        changeLanguage(partnerData.language);
      }

      const platformIcon = partnerData.platform === 'instagram' ? 'üì±' : 'üí¨';
      document.getElementById('partner-info').textContent = 
        `${platformIcon} ${partnerData.channelName} ‚Ä¢ ${translations[currentLanguage].labelRefCode}: ${partnerData.referralCode}`;

      document.getElementById('display-code').textContent = partnerData.referralCode;

      const referralLink = `https://yourapp.com/?ref=${partnerData.referralCode}`;
      document.getElementById('display-link').textContent = referralLink;

      loadDashboardData(partnerData);
    }

    // ===== LOAD DASHBOARD DATA =====
    async function loadDashboardData(partnerData) {
      try {
        console.log('üîç Loading users for referral code:', partnerData.referralCode);
        const startTime = performance.now();

        const usersMap = new Map();

        const query1 = dataDb.collection('users')
          .where('referral.code', '==', partnerData.referralCode);

        const query2 = dataDb.collection('users')
          .where('lastReferral.code', '==', partnerData.referralCode);

        const [snapshot1, snapshot2] = await Promise.all([
          query1.get(),
          query2.get()
        ]);

        console.log('‚úÖ Query 1 results:', snapshot1.size);
        console.log('‚úÖ Query 2 results:', snapshot2.size);

        [snapshot1, snapshot2].forEach(snapshot => {
          snapshot.forEach(doc => {
            const userData = doc.data();
            const userId = doc.id;

            if (!usersMap.has(userId)) {
              let entryPoint = 'Unknown';
              if (userData.referral?.code === partnerData.referralCode) {
                entryPoint = 'üö™ Login';
              } else if (userData.lastReferral?.code === partnerData.referralCode) {
                const ep = userData.lastReferral.entryPoint || 'lastReferral';
                if (ep === 'xpMultiplier') entryPoint = '‚ö° XP Multiplier';
                else if (ep === 'streakProtector') entryPoint = 'üõ°Ô∏è Streak Protector';
                else if (ep === 'specialBadge') entryPoint = 'üèÖ Special Badge';
                else entryPoint = ep;
              }

              usersMap.set(userId, {
                id: userId,
                name: userData.name || 'Unknown',
                age: userData.age || 0,
                joinedDate: userData.createdAt ? userData.createdAt.toDate() : new Date(),
                monthlyActivity: userData.monthlyActivity || [],
                entryPoint: entryPoint
              });
            }
          });
        });

        const query3 = dataDb.collection('users')
          .where('referralSources', 'array-contains', { code: partnerData.referralCode });

        try {
          const snapshot3 = await query3.get();
          console.log('‚úÖ Query 3 results:', snapshot3.size);

          snapshot3.forEach(doc => {
            const userData = doc.data();
            const userId = doc.id;

            if (!usersMap.has(userId)) {
              usersMap.set(userId, {
                id: userId,
                name: userData.name || 'Unknown',
                age: userData.age || 0,
                joinedDate: userData.createdAt ? userData.createdAt.toDate() : new Date(),
                monthlyActivity: userData.monthlyActivity || [],
                entryPoint: 'üéØ Referral Source'
              });
            }
          });
        } catch (e) {
          console.log('Note: referralSources query not possible');
        }

        const finalUsers = Array.from(usersMap.values());

        const endTime = performance.now();
        console.log(`üìä Total matched users: ${finalUsers.length}`);
        console.log(`‚ö° Loading time: ${((endTime - startTime) / 1000).toFixed(2)} seconds`);

        updateStats(finalUsers);
        displayUsers(finalUsers);

      } catch (error) {
        console.error('‚ùå Error loading dashboard data:', error);
        const t = translations[currentLanguage];
        document.getElementById('users-content').innerHTML = 
          `<div class="no-users">${t.errorLoadingData}</div>`;
      }
    }

    // ===== UPDATE STATS =====
    function updateStats(users) {
      const today = new Date().toISOString().split('T')[0];
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();

      const todayUsers = users.filter(u => {
        const joinDate = new Date(u.joinedDate).toISOString().split('T')[0];
        return joinDate === today;
      }).length;

      const monthUsers = users.filter(u => {
        const joinDate = new Date(u.joinedDate);
        return joinDate.getMonth() === currentMonth && joinDate.getFullYear() === currentYear;
      }).length;

      let totalActiveDays = 0;
      users.forEach(user => {
        const thisMonthActivity = user.monthlyActivity.filter(dateStr => {
          const date = new Date(dateStr);
          return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        });
        totalActiveDays += thisMonthActivity.length;
      });

      document.getElementById('stat-total').textContent = users.length;
      document.getElementById('stat-today').textContent = todayUsers;
      document.getElementById('stat-month').textContent = monthUsers;
      document.getElementById('stat-active').textContent = totalActiveDays;
    }

    // ===== DISPLAY USERS =====
    function displayUsers(users) {
      const t = translations[currentLanguage];
      const content = document.getElementById('users-content');

      if (users.length === 0) {
        content.innerHTML = `<div class="no-users">${t.noUsers}</div>`;
        return;
      }

      users.sort((a, b) => new Date(b.joinedDate) - new Date(a.joinedDate));

      let tableHTML = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>${t.tableHeaderName}</th>
                <th>${t.tableHeaderAge}</th>
                <th>${t.tableHeaderJoined}</th>
                <th>${t.tableHeaderEntry}</th>
                <th>${t.tableHeaderActive}</th>
              </tr>
            </thead>
            <tbody>
      `;

      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();

      users.forEach(user => {
        const maskedName = maskName(user.name);
        const formattedDate = formatDate(user.joinedDate);

        const activeDaysThisMonth = user.monthlyActivity.filter(dateStr => {
          const date = new Date(dateStr);
          return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        }).length;

        tableHTML += `
          <tr>
            <td>${maskedName}</td>
            <td>${user.age}</td>
            <td>${formattedDate}</td>
            <td>${user.entryPoint}</td>
            <td>${activeDaysThisMonth} ${t.days}</td>
          </tr>
        `;
      });

      tableHTML += `
            </tbody>
          </table>
        </div>
      `;

      content.innerHTML = tableHTML;
    }

    // ===== HELPER FUNCTIONS =====
    function maskName(name) {
      if (!name || name.length <= 4) return (name || 'User') + '****';
      return name.substring(0, 4) + '****';
    }

    function formatDate(date) {
      const d = new Date(date);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function copyCode() {
      const t = translations[currentLanguage];
      const code = document.getElementById('display-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert(t.alertCodeCopied);
      }).catch(err => {
        alert(t.alertCopyFailed + err);
      });
    }

    function copyLink() {
      const t = translations[currentLanguage];
      const link = document.getElementById('display-link').textContent;
      navigator.clipboard.writeText(link).then(() => {
        alert(t.alertLinkCopied);
      }).catch(err => {
        alert(t.alertCopyFailed + err);
      });
    }

    // ===== LOGOUT =====
    function logout() {
      const t = translations[currentLanguage];
      if (confirm(t.confirmLogout)) {
        localStorage.removeItem('partnerData');
        currentPartnerData = null;
        showSetupScreen();
      }
    }

    // ===== SHOW SETUP SCREEN =====
    function showSetupScreen() {
      document.getElementById('setup-screen').style.display = 'block';
      document.getElementById('dashboard-screen').style.display = 'none';
    }

    // ===== LANGUAGE CHANGE =====
    function changeLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('partnerLanguage', lang);

      const t = translations[lang];

      document.getElementById('setup-title').textContent = t.setupTitle;
      document.getElementById('setup-subtitle').textContent = t.setupSubtitle;
      document.getElementById('label-platform').textContent = t.labelPlatform;
      document.getElementById('option-select-platform').textContent = t.optionSelectPlatform;
      document.getElementById('label-channel-name').textContent = t.labelChannelName;
      document.getElementById('channel-name').placeholder = t.placeholderChannelName;
      document.getElementById('label-referral-code').textContent = t.labelReferralCode;
      document.getElementById('referral-code').placeholder = t.placeholderReferralCode;

      const setupBtn = document.getElementById('setup-btn');
      if (setupBtn.textContent.includes('Setting up') || setupBtn.textContent.includes('‡§∏‡•á‡§ü‡§Ö‡§™') || setupBtn.textContent.includes('‡™∏‡´á‡™ü‡™Ö‡™™')) {
        setupBtn.textContent = t.btnSettingUp;
      } else {
        setupBtn.textContent = t.btnEnterDashboard;
      }

      document.getElementById('dashboard-title').textContent = t.dashboardTitle;
      document.getElementById('btn-logout').textContent = t.btnLogout;
      document.getElementById('referral-details-title').textContent = t.referralDetailsTitle;
      document.getElementById('label-ref-code').textContent = t.labelRefCode;
      document.getElementById('label-ref-link').textContent = t.labelRefLink;
      document.getElementById('btn-copy-code').textContent = t.btnCopyCode;
      document.getElementById('btn-copy-link').textContent = t.btnCopyLink;
      document.getElementById('stat-label-total').textContent = t.statLabelTotal;
      document.getElementById('stat-label-today').textContent = t.statLabelToday;
      document.getElementById('stat-label-month').textContent = t.statLabelMonth;
      document.getElementById('stat-label-active').textContent = t.statLabelActive;
      document.getElementById('users-section-title').textContent = t.usersSectionTitle;
      document.getElementById('loading-text').textContent = t.loadingText;

      document.getElementById('language').value = lang;
      document.getElementById('dashboard-language').value = lang;

      // Update partner info if dashboard is visible
      if (currentPartnerData && document.getElementById('dashboard-screen').style.display === 'block') {
        const platformIcon = currentPartnerData.platform === 'instagram' ? 'üì±' : 'üí¨';
        document.getElementById('partner-info').textContent = 
          `${platformIcon} ${currentPartnerData.channelName} ‚Ä¢ ${t.labelRefCode}: ${currentPartnerData.referralCode}`;
      }
    }
  </script>
</body>
</html>
